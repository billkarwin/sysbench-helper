:

: ${CSVDATA:=sysbench-data}
: ${SBLENGTH:=100000000}
: ${SBDATABASE:=sysbench}
: ${SBTABLE:=sbtest2}
: ${SBPARTITIONS:=101}

if [ ! -d $CSVDATA ] ; then
	echo "Starting creating CSV files..."
	time seq 1 $SBPARTITIONS |
	parallel --bibtex --eta --progress --results $CSVDATA \
	  "awk -v CSVLENGTH=$SBLENGTH -v CSVOFFSET={} -v CSVPARTITIONS=$SBPARTITIONS -f create-data.awk" >/dev/null
	echo "Done creating CSV files."

	find $CSVDATA -name "stdout" -execdir mv {} $SBTABLE \;
fi

mysql -e "CREATE DATABASE IF NOT EXISTS $SBDATABASE DEFAULT CHARSET=utfmb4"
mysql $SBDATABASE -e "DROP TABLE IF EXISTS $SBTABLE"
mysql $SBDATABASE -e "CREATE TABLE $SBTABLE ( \
  id INT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY, \
  k INT UNSIGNED NOT NULL, \
  c char(120) NOT NULL, \
pad char(60) NOT NULL, KEY(k) \
) ENGINE=InnoDB \
PARTITION BY HASH(id) PARTITIONS $SBPARTITIONS"

echo "Starting loading CSV files..."
THREADS=$((`parallel --number-of-cores` * 2))
time mysqlimport --verbose --local --use-threads=$THREADS --fields-terminated-by="," $SBDATABASE $CSVDATA/1/*/$SBTABLE
echo "Done loading CSV files."
